# mediamicroservices/LTOpers Database Features

## Introduction
The mediamicroservices database supports the storing and querying of a variety of information created by both [mediamicroservices](https://github.com/mediamicroservices/mm) and [LTOpers](https://github.com/amiaopensource/ltopers). This document provides database setup information, a breakdown of the structure of the database and examples of the scripts currently used to interact with it.

## Database specific scripts
* createmmdb
* dbbackup
* makefingerprint
* searchfingerprint
* updatingplist

## Database Configuration

To configure the database, run the command `createmmdb -c` on your __host__ computer and follow the prompts.  This will set up the database as well as facilitate user creation. To create users without creating a new database, use the command `createmmdb -u`.  At the end of user creation, the script will supply a command to create a log-in profile for the database.  It should look something like this: `mysql_config_editor set --login-path=your_user_config --host=xx.xx.xxx.xxx --user=your_user --password`. Run this command on your __user__ computer and enter the password for the user you created when prompted.  This will create the SQL log-in profile that you will use when configuring the microservices. NOTE: When supplying the suggested command, the script does its best to auto-fill the host IP address.  You may wish to verify that this is the correct IP.

To finalize the database setup, run `mmconfig` (GUI mode) or `mmconfig -t` (CLI) and select 'Y' in the PREMIS Database logging section, (or set to Y if using CLI). Enter the database name and log-in profile you have created to finalize DB connectivity. Additional database options (such as fingerprint generation) can be set at this time.

![Database GUI Example](https://github.com/mediamicroservices/mm/blob/master/Resources/mmgui_dbsetup.png)

## Database Backup
Mediamicroservices includes a script for database backup.  This can be either run manually or set up as an automated process.  After configuring the backup script, running `dbbackup` will create a zipped backup in the chosen location.  To automate this process use Brew Services.  Typing `brew services start mm` will cause the db to be backed up automatically using the included plist file.  By default, backups will occur daily at 2:00 AM.

To configure database backup use the command `dbbackup -e`. This will open the config file in a terminal editor. Set the neccessary variables to your desired values.


## Database structure
The Database is divided into six tables with the following structure:

***

#### object:
__Contains identifying information for objects in the database.__

|objectIdentifierValueID|objectIdentifierValue|objectDB_Insertion|object_LastTouched|
|---|---|---|---|
|Auto-incrementing number for object records|Name of object|Date/Time Object added to DB|Date/Time Object was last updated|

***

#### event:
__Tracks occurences of events affecting Objects contained in database.__

|eventIdentifierValueID|objectIdentifierValue|eventType|eventDateTime|eventDetail|eventOutcome|eventDetailOPT|eventDetailCOMPNAME|linkingAgentIdentifierValue|
|---|---|---|---|---|---|---|---|---|
|Auto-incrementing number for event records|Name of target object for event|PREMIS type for event|Date/Time of event|Name of script|Outcome of event|Options used for script|Computer used for event|User who initiated event|

***

#### fixity
__Captures fixity information generated by fixity events.__

|fixityIdentifierValueID|eventIdentifierValue|objectIdentifierValue|eventDateTime|eventDetail|messageDigestAlgorithm|messageDigestSOURCE|messageDigestPATH|messageDigestFILENAME|messageDigestHASH|
|---|---|---|---|---|---|---|---|---|---|
|Auto-incrementing number for fixity records|ID of corresponding event|Name of corresponding object|Date/Time of fixity event|Script name|Hashing algorithm|Source of hash|Location of hash|Name of file hashed|Hash|

***

#### objectCharacteristics
__Captures information from sidecar files generated during microservices ingest.__

|objectCharacteristicValueID|mediaInfo|captureLog|
|---|---|---|
|Auto-incrementing number for object characteristic records|Contents of associated media info xml file|Contents of associated capture log|

***

#### ltoSchema
__Captures contents of LTO schema files generated through LTOpers.__

|ltoSchemaValueID|ltoID|fileName|filePath|fileSize|modifyTime|
|---|---|---|---|---|---|
|Auto-incrementing number for object characteristic records|ID for corresponding tape|file name|File path|File size|Date/Time of last file modification|

***

#### fingerprints
__Stores fingerprints (perceptual hash information).__

|hashNumber|objectIdentifierValue|startframe|endframe|hash1|hash2|hash3|hash4|hash5|
|---|---|---|---|---|---|---|---|---|
|Auto-incrementing number for hashes|Name of corresponding item|Start frame for hash|End frame for hash|First component of hash|Second component of hash|Third component of hash|Fourth component of hash|Fifth component of hash|

## Database Search Scripts

#### searchlto

Searches the LTO schema information stored in the database. Input for standard search can consist either of a Tape ID or a Media ID. If the `-c` flag is used, input is a file to be compared against information stored in the DB. Input file will be compared for modification time, file size and file name.

Usage: searchlto [-h] (help) [-c] (compares an input file to file information stored in DB) [-f] (shows full schema) [Input]



#### searchfingerprint

Generates fingerprints (perceptual hashes) from whole or specified portion of an input video file and compares them against fingerprints stored in the database. Outputs any detected matches in 500 frame segments both in the terminal and in an optional preview window. Preview window will attempt to locate the portions of input video for which matches were found.

Usage: searchfingerprint [ -h ] (help) [ -i ] (set in time) [ -o ] (set out time) [ -t ] (text only-don't display video preview) [Input]

## Database Support Scripts
#### createmmdb
#### dbbackup
#### updatingplist
